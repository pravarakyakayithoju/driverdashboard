<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alerion | Driver Safety Monitor</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* All your previous CSS styles remain the same */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f6fa;
            color: #2d3748;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-icon {
            width: 50px;
            height: 50px;
            background: #4361ee;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: background 0.3s ease;
        }
        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .sos-button {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .sos-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        .sos-button.pulsing {
            animation: sosPulse 1.5s infinite;
        }
        @keyframes sosPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .alert-banner {
            display: none;
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            align-items: center;
            gap: 20px;
            animation: pulse 2s infinite;
        }
        .alert-banner.sos {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #d97706;
            animation: sosAlert 1s infinite;
        }
        @keyframes sosAlert {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.01); }
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        .drivers-card, .history-card {
            grid-column: 1 / -1;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        .status-indicator-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        .status-open {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 4px solid #10b981;
        }
        .status-closed {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 4px solid #ef4444;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }
        .drivers-list, .history-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .driver-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 4px solid #e2e8f0;
        }
        .driver-item.alert { border-left-color: #ef4444; background: #fef2f2; }
        .driver-item.warning { border-left-color: #f59e0b; background: #fffbeb; }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-safe { background: #d1fae5; color: #065f46; }
        .status-warning { background: #fef3c7; color: #92400e; }
        .status-danger { background: #fee2e2; color: #991b1b; }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }
        .action-btn.contact { background: #4361ee; color: white; }
        .action-btn.view { background: #e2e8f0; color: #64748b; }
        .action-btn.delete { background: #ef4444; color: white; }
        
        /* EAR Value Display */
        .ear-display {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .ear-value {
            font-size: 42px;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .ear-label {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 600;
        }
        .ear-threshold {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 8px;
        }
        .ear-status {
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        .ear-open {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .ear-closed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .driver-contact-card {
            background: #121212;
            border-radius: 20px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            margin-top: 20px;
            text-align: center;
            transition: 0.3s ease;
        }

        .driver-contact-card:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 16px rgba(0,0,0,0.6);
        }

        .contact-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-evenly;
        }

        .btn {
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .call-btn {
            background: #007bff;
            color: white;
        }

        .call-btn:hover {
            background: #0056b3;
        }

        .whatsapp-btn {
            background: #25D366;
            color: white;
        }

        .whatsapp-btn:hover {
            background: #1EBE5B;
        }

        /* Sensitivity settings */
        .sensitivity-controls {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        .sensitivity-slider {
            width: 100%;
            margin: 10px 0;
        }
        .sensitivity-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Audio permission message */
        .audio-permission-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffeb3b;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            border-left: 4px solid #ffc107;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-weight: 600;
        }

        /* Sound controls */
        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #10b981;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .sound-test {
            margin-top: 10px;
        }
        .sound-test button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Alert level indicators */
        .alert-info {
            font-size: 12px;
            color: #64748b;
            margin-top: 10px;
            text-align: center;
        }

        /* History items */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #e2e8f0;
        }
        .history-time {
            font-size: 12px;
            color: #64748b;
        }
        .history-status {
            font-size: 14px;
            font-weight: 600;
        }
        .status-open-badge { color: #10b981; }
        .status-closed-badge { color: #ef4444; }
        .status-sos-badge { color: #dc2626; font-weight: bold; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Progress bar for EAR */
        .ear-progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .ear-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Add Driver Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4361ee;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .btn-primary {
            background: #4361ee;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #3a56d4;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #64748b;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-secondary:hover {
            background: #d1d9e6;
        }

        .add-driver-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .add-driver-btn:hover {
            background: #0da271;
        }

        .driver-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4361ee;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .driver-info {
            display: flex;
            align-items: center;
        }

        .driver-details {
            display: flex;
            flex-direction: column;
        }

        .driver-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .driver-vehicle {
            font-size: 14px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <!-- Add Driver Modal -->
    <div id="addDriverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Driver</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="addDriverForm">
                <div class="form-group">
                    <label for="driverName">Driver Name</label>
                    <input type="text" id="driverName" placeholder="Enter driver's full name" required>
                </div>
                <div class="form-group">
                    <label for="driverPhone">Phone Number</label>
                    <input type="tel" id="driverPhone" placeholder="Enter driver's phone number" required>
                </div>
                <div class="form-group">
                    <label for="driverVehicle">Vehicle ID</label>
                    <input type="text" id="driverVehicle" placeholder="Enter vehicle ID" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelAddDriver">Cancel</button>
                    <button type="submit" class="btn-primary">Add Driver</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üöó</div>
                <h1>Alerion <small style="font-size: 14px; color: #666;">Driver Safety Monitor</small></h1>
            </div>
            <div class="header-controls">
                <div class="status-indicator">
                    <div class="status-dot" id="connDot"></div>
                    <span id="connText">Connecting...</span>
                </div>
                <button class="sos-button" id="sosButton">
                    <span>üö®</span>
                    SOS EMERGENCY
                </button>
            </div>
        </header>

        <div id="eyeAlert" class="alert-banner">
            <div class="alert-icon-large">‚ö†Ô∏è</div>
            <div class="alert-content">
                <h3>Driver Alert: Eyes Closed</h3>
                <p>Eyes have been closed for <span id="closedDuration">0</span> seconds.</p>
                <p>EAR Value: <span id="alertEarValue">0.000</span> (Threshold: 0.25)</p>
            </div>
        </div>

        <!-- Driver Contact Section -->
        <div class="card driver-contact-card">
            <h2 class="card-title">Driver Contact</h2>
            <div class="driver-info">
                <p><strong>Name:</strong> Ramesh Kumar</p>
                <p><strong>Vehicle ID:</strong> MH12AB3456</p>
                <p><strong>Mobile:</strong> +91 9876543210</p>
            </div>

            <div class="contact-buttons">
                <a href="tel:+919876543210" class="btn call-btn">üìû Call Driver</a>
                <a href="https://wa.me/919876543210" target="_blank" class="btn whatsapp-btn">üí¨ WhatsApp</a>
            </div>
        </div>

        <div id="sosAlert" class="alert-banner sos" style="display: none;">
            <div class="alert-icon-large">üö®</div>
            <div class="alert-content">
                <h3>EMERGENCY SOS ACTIVATED</h3>
                <p>Driver has triggered emergency SOS. Immediate assistance required!</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üëÅÔ∏è Eye Status Monitor</h2>
                </div>
                
                <!-- EAR Value Display -->
                <div class="ear-display">
                    <div class="ear-label">EYE ASPECT RATIO (EAR)</div>
                    <div class="ear-value" id="earValue">0.000</div>
                    <div class="ear-progress">
                        <div class="ear-progress-fill" id="earProgress" style="width: 0%"></div>
                    </div>
                    <div class="ear-threshold">Threshold: 0.25 (Below = Eyes Closed)</div>
                    <div class="ear-status ear-open" id="earStatusText">EYES OPEN</div>
                </div>

                <div class="status-card">
                    <div class="status-indicator-large status-open" id="statusIndicator">
                        <span id="statusEmoji">üëÅÔ∏è</span>
                    </div>
                    <div class="status-text" id="statusText">Eyes Open</div>
                    <div class="status-duration" id="statusDuration">All clear</div>
                    <div class="alert-info" id="alertInfo">
                        Alerts trigger after 10+ seconds of eye closure
                    </div>
                </div>

                <!-- Sensitivity Controls -->
                <div class="sensitivity-controls">
                    <div style="font-weight: 600; margin-bottom: 10px;">Alert Threshold</div>
                    <div>
                        <label>Alert after: <span id="thresholdValue">10.0</span> seconds</label>
                        <input type="range" id="sensitivitySlider" class="sensitivity-slider" 
                               min="5" max="20" step="1" value="10">
                        <div class="sensitivity-labels">
                            <span>5 seconds</span>
                            <span>20 seconds</span>
                        </div>
                    </div>
                </div>

                <div class="sound-toggle">
                    <span>Alert Sound:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundToggle" checked />
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="sound-test">
                    <button id="testSoundBtn">Test Emergency Sound</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìä Driving Statistics</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalAlerts">0</div>
                        <div class="stat-label">Total Alerts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentSession">0m</div>
                        <div class="stat-label">Current Session</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="maxClosure">0s</div>
                        <div class="stat-label">Max Closure Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="alertLevel">Low</div>
                        <div class="stat-label">Alert Level</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentEar">0.000</div>
                        <div class="stat-label">Current EAR</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="sensitivityValue">1.0x</div>
                        <div class="stat-label">Sensitivity</div>
                    </div>
                </div>
            </div>

            <div class="card drivers-card">
                <div class="card-header">
                    <h2 class="card-title">üë• Active Drivers</h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="driver-count"><span id="activeDriversCount">0</span> Active</div>
                        <button class="add-driver-btn" id="addDriverBtn">
                            <span>+</span> Add Driver
                        </button>
                    </div>
                </div>
                <div class="drivers-list" id="driversList">
                    <!-- Drivers will be loaded here -->
                </div>
            </div>

            <div class="card history-card">
                <div class="card-header">
                    <h2 class="card-title">üìù Alert History</h2>
                </div>
                <div class="history-list" id="historyList">
                    <div class="history-item">
                        <span class="history-time">Just now</span>
                        <span class="history-status status-open-badge">System Started - EAR Detection Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Multiple audio formats for better browser compatibility -->
    <audio id="alertSoundEmergency" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/250/250-preview.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        // Global variables
        let criticalAlertInterval = null;
        let drivers = [
            {id: 1, name: "John Driver", vehicle: "Truck A123", status: "safe", location: "Highway I-95", phone: "+1-555-0101"},
            {id: 2, name: "Sarah Wilson", vehicle: "Van B456", status: "warning", location: "Route 66", phone: "+1-555-0102"},
            {id: 3, name: "Mike Johnson", vehicle: "Car C789", status: "danger", location: "City Center", phone: "+1-555-0103"}
        ];
        let alertThreshold = 10.0;
        let lastAlertTime = 0;
        let currentEAR = 0.0;
        let currentSensitivity = 1.0;

        // Enhanced Sound System with Fallbacks
        class SoundManager {
            constructor() {
                this.soundEnabled = true;
                this.audioInitialized = false;
                this.isEmergencyPlaying = false;
                this.audioContext = null;
                this.oscillator = null;
                
                this.initializeAudio();
            }

            initializeAudio() {
                // Try to initialize HTML5 Audio first
                const audioElement = document.getElementById('alertSoundEmergency');
                if (audioElement) {
                    audioElement.volume = 0.7;
                    
                    const playPromise = audioElement.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            audioElement.pause();
                            audioElement.currentTime = 0;
                            console.log("üîä HTML5 Audio initialized successfully");
                            this.audioInitialized = true;
                        }).catch(error => {
                            console.log("üîá HTML5 Audio initialization failed, trying Web Audio API");
                            this.initializeWebAudio();
                        });
                    }
                } else {
                    this.initializeWebAudio();
                }
            }

            initializeWebAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("üîä Web Audio API initialized");
                    this.audioInitialized = true;
                } catch (error) {
                    console.error("üîá Web Audio API not supported:", error);
                    this.showAudioPermissionMessage();
                }
            }

            playEmergencySound() {
                if (!this.soundEnabled) {
                    console.log("üîá Sound is disabled");
                    return;
                }

                if (!this.audioInitialized) {
                    console.log("üîá Audio not initialized");
                    this.initializeAudio();
                    return;
                }

                const audioElement = document.getElementById('alertSoundEmergency');
                if (audioElement && this.audioInitialized) {
                    this.playHTML5Sound(audioElement);
                } else if (this.audioContext) {
                    this.playWebAudioSound();
                } else {
                    console.log("üîá No audio method available");
                    this.showAudioPermissionMessage();
                }
            }

            playHTML5Sound(audioElement) {
                if (this.isEmergencyPlaying) return;

                audioElement.currentTime = 0;
                const playPromise = audioElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        this.isEmergencyPlaying = true;
                        console.log("üö® Emergency sound started (HTML5)");
                        
                        audioElement.onended = () => {
                            this.isEmergencyPlaying = false;
                        };
                    }).catch(error => {
                        console.log("üîá HTML5 sound play failed:", error);
                        this.playWebAudioSound();
                    });
                }
            }

            playWebAudioSound() {
                if (this.isEmergencyPlaying || !this.audioContext) return;

                try {
                    this.oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    this.oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    this.oscillator.type = 'sawtooth';
                    this.oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                    this.oscillator.frequency.exponentialRampToValueAtTime(1200, this.audioContext.currentTime + 0.5);
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                    
                    this.oscillator.start();
                    this.isEmergencyPlaying = true;
                    
                    console.log("üö® Emergency sound started (Web Audio)");
                    
                    setTimeout(() => {
                        this.stopEmergencySound();
                    }, 1000);
                    
                } catch (error) {
                    console.error("üîá Web Audio sound failed:", error);
                }
            }

            stopEmergencySound() {
                const audioElement = document.getElementById('alertSoundEmergency');
                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                }
                
                if (this.oscillator) {
                    this.oscillator.stop();
                    this.oscillator = null;
                }
                
                this.isEmergencyPlaying = false;
                console.log("üîá Emergency sound stopped");
            }

            setSoundEnabled(enabled) {
                this.soundEnabled = enabled;
                if (!enabled) {
                    this.stopEmergencySound();
                }
                console.log("üîä Sound enabled:", enabled);
            }

            showAudioPermissionMessage() {
                const existingMessage = document.querySelector('.audio-permission-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                const message = document.createElement('div');
                message.className = 'audio-permission-message';
                message.innerHTML = 'üîä Click "Test Emergency Sound" to enable audio permissions';
                document.body.appendChild(message);
                
                setTimeout(() => {
                    if (message.parentNode) {
                        message.remove();
                    }
                }, 5000);
            }
        }

        // Initialize Sound Manager
        const soundManager = new SoundManager();

        // Critical alert sound function
        function playCriticalAlertSound() {
            const criticalAlertSound = new Audio('error.mp3');
            criticalAlertSound.volume = 0.8;
            
            const playPromise = criticalAlertSound.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log("üö® Critical alert sound started");
                }).catch(error => {
                    console.log("üîá Critical alert sound failed:", error);
                    // Fallback to emergency sound
                    soundManager.playEmergencySound();
                });
            }
        }

        // Socket.IO connection
        console.log("üöÄ Attempting to connect to server...");
        
        const socket = io('http://localhost:5000', {
            transports: ['websocket', 'polling']
        });

        // DOM elements
        const connDot = document.getElementById("connDot");
        const connText = document.getElementById("connText");
        const eyeAlert = document.getElementById("eyeAlert");
        const sosAlert = document.getElementById("sosAlert");
        const sosButton = document.getElementById("sosButton");
        const closedDuration = document.getElementById("closedDuration");
        const alertEarValue = document.getElementById("alertEarValue");
        const statusIndicator = document.getElementById("statusIndicator");
        const statusEmoji = document.getElementById("statusEmoji");
        const statusText = document.getElementById("statusText");
        const statusDuration = document.getElementById("statusDuration");
        const earValue = document.getElementById("earValue");
        const earProgress = document.getElementById("earProgress");
        const earStatusText = document.getElementById("earStatusText");
        const currentEar = document.getElementById("currentEar");
        const sensitivityValue = document.getElementById("sensitivityValue");
        const soundToggle = document.getElementById("soundToggle");
        const testSoundBtn = document.getElementById("testSoundBtn");
        const historyList = document.getElementById("historyList");
        const driversList = document.getElementById("driversList");
        const activeDriversCount = document.getElementById("activeDriversCount");
        const totalAlerts = document.getElementById("totalAlerts");
        const currentSession = document.getElementById("currentSession");
        const maxClosure = document.getElementById("maxClosure");
        const alertLevel = document.getElementById("alertLevel");
        const sensitivitySlider = document.getElementById("sensitivitySlider");
        const thresholdValue = document.getElementById("thresholdValue");
        const alertInfo = document.getElementById("alertInfo");
        const addDriverBtn = document.getElementById("addDriverBtn");
        const addDriverModal = document.getElementById("addDriverModal");
        const closeModal = document.querySelector(".close-modal");
        const cancelAddDriver = document.getElementById("cancelAddDriver");
        const addDriverForm = document.getElementById("addDriverForm");

        // Modal functionality
        addDriverBtn.addEventListener('click', () => {
            addDriverModal.style.display = 'flex';
        });

        closeModal.addEventListener('click', () => {
            addDriverModal.style.display = 'none';
        });

        cancelAddDriver.addEventListener('click', () => {
            addDriverModal.style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === addDriverModal) {
                addDriverModal.style.display = 'none';
            }
        });

        // Add driver form submission
        addDriverForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('driverName').value;
            const phone = document.getElementById('driverPhone').value;
            const vehicle = document.getElementById('driverVehicle').value;
            
            // Generate a new driver ID
            const newId = drivers.length > 0 ? Math.max(...drivers.map(d => d.id)) + 1 : 1;
            
            // Add new driver
            const newDriver = {
                id: newId,
                name: name,
                vehicle: vehicle,
                status: "safe",
                location: "Not assigned",
                phone: phone
            };
            
            drivers.push(newDriver);
            updateDriversList(drivers);
            
            // Reset form and close modal
            addDriverForm.reset();
            addDriverModal.style.display = 'none';
            
            // Add to history
            addHistoryItem(`Added new driver: ${name} (${vehicle})`, 'open');
        });

        // Delete driver function
        function deleteDriver(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (driver && confirm(`Are you sure you want to delete ${driver.name}?`)) {
                drivers = drivers.filter(d => d.id !== driverId);
                updateDriversList(drivers);
                addHistoryItem(`Deleted driver: ${driver.name}`, 'closed');
            }
        }

        // Sensitivity slider handler
        sensitivitySlider.addEventListener('input', function() {
            alertThreshold = parseFloat(this.value);
            thresholdValue.textContent = alertThreshold.toFixed(1);
            updateAlertInfo();
        });

        function updateAlertInfo() {
            alertInfo.textContent = `Alerts trigger after ${alertThreshold.toFixed(1)}+ seconds of eye closure`;
        }

        // Sound toggle handler
        soundToggle.addEventListener("change", function () {
            soundManager.setSoundEnabled(this.checked);
        });

        // Test sound button handler
        testSoundBtn.addEventListener("click", function() {
            console.log("Testing emergency sound");
            soundManager.playEmergencySound();
        });

        // Connection events
        socket.on('connect', () => {
            console.log('‚úÖ SUCCESS: Connected to server!');
            connDot.classList.add('connected');
            connText.textContent = 'Connected';
            connText.style.color = '#10b981';
            addHistoryItem('Connected to server - EAR Detection Active', 'open');
        });

        socket.on('disconnect', (reason) => {
            console.log('‚ùå Disconnected:', reason);
            connDot.classList.remove('connected');
            connText.textContent = 'Disconnected';
            connText.style.color = '#ef4444';
            addHistoryItem('Disconnected from server', 'closed');
            soundManager.stopEmergencySound();
        });

        socket.on('connect_error', (error) => {
            console.error('üîå Connection error:', error);
            connText.textContent = 'Connection Failed';
            connText.style.color = '#ef4444';
        });

        // Handle eye status data with EAR values
        socket.on('eye_status', (data) => {
            console.log('üëÅÔ∏è Eye status received:', data);
            
            const status = data.status;
            const duration = data.duration || 0;
            const earValueData = data.ear_value || 0.0;
            const sensitivity = data.sensitivity || 1.0;
            
            // Update EAR display
            currentEAR = earValueData;
            updateEARDisplay(earValueData, status);
            currentEar.textContent = earValueData.toFixed(3);
            sensitivityValue.textContent = sensitivity.toFixed(1) + 'x';
            currentSensitivity = sensitivity;
            
            console.log(`üìä Parsed: status="${status}", duration=${duration}s, EAR=${earValueData}, threshold=${alertThreshold}s`);
            
            // Only show alert if eyes are closed for MORE than threshold
            if (status === 'closed' && duration > alertThreshold) {
                console.log(`üö® ALERT: Eyes closed for ${duration}s (threshold: ${alertThreshold}s)`);
                showAlertState(duration, earValueData);
                
                // Play sound only once per alert (not continuously)
                const currentTime = Date.now();
                if (currentTime - lastAlertTime > 5000) {
                    soundManager.playEmergencySound();
                    lastAlertTime = currentTime;
                }
                
            } else {
                console.log(`‚úÖ NORMAL: Eyes ${status} for ${duration}s`);
                showNormalState();
            }
        });

        // Handle statistics updates
        socket.on('statistics_update', (data) => {
            console.log('üìà Statistics update:', data);
            totalAlerts.textContent = data.total_alerts || 0;
            
            // Calculate session duration
            const sessionDuration = Math.floor((Date.now()/1000 - data.current_session_start) / 60);
            currentSession.textContent = `${sessionDuration}m`;
            
            maxClosure.textContent = `${Math.round(data.max_closure_time || 0)}s`;
        });

        // Handle drivers updates
        socket.on('drivers_update', (data) => {
            console.log('üë• Drivers update:', data);
            updateDriversList(data);
        });

        function updateEARDisplay(earValueData, status) {
            // Update EAR value
            earValue.textContent = earValueData.toFixed(3);
            
            // Update progress bar (EAR typically ranges from 0.1 to 0.4)
            const progressPercent = Math.min(Math.max((earValueData / 0.4) * 100, 0), 100);
            earProgress.style.width = progressPercent + '%';
            
            // Update EAR status
            if (status === 'closed' || earValueData < 0.25) {
                earStatusText.textContent = 'EYES CLOSED';
                earStatusText.className = 'ear-status ear-closed';
            } else {
                earStatusText.textContent = 'EYES OPEN';
                earStatusText.className = 'ear-status ear-open';
            }
        }

        function showNormalState() {
            eyeAlert.style.display = 'none';
            statusIndicator.className = 'status-indicator-large status-open';
            statusEmoji.textContent = 'üëÅÔ∏è';
            statusText.textContent = 'Eyes Open';
            statusDuration.textContent = 'All clear';
            alertLevel.textContent = 'Low';
            alertLevel.style.color = '#4ade80';
        }

        function showAlertState(duration, earValueData) {
            eyeAlert.style.display = 'flex';
            statusIndicator.className = 'status-indicator-large status-closed';
            statusEmoji.textContent = 'üò¥';
            statusText.textContent = 'Eyes Closed';
            statusDuration.textContent = `For ${duration.toFixed(1)}s`;
            closedDuration.textContent = duration.toFixed(1);
            alertEarValue.textContent = earValueData.toFixed(3);
            updateAlertLevel(duration);
            
            // Add to history only when alert first triggers
            if (duration >= alertThreshold && duration < alertThreshold + 1) {
                addHistoryItem(`Eyes closed for ${duration.toFixed(1)}s - ALERT (EAR: ${earValueData.toFixed(3)})`, 'closed');
            }
        }

        // SOS handler - PLAY SOUND ON SOS
        socket.on('sos_alert', (data) => {
            console.log('üö® SOS Alert received from server:', data);
            triggerSOS();
        });

        // SOS functionality
        sosButton.addEventListener('click', triggerSOS);

        function triggerSOS() {
            console.log('üö® MANUAL SOS EMERGENCY TRIGGERED');
            
            // Visual feedback
            sosButton.classList.add('pulsing');
            sosAlert.style.display = 'flex';
            
            // Play emergency sound immediately
            soundManager.playEmergencySound();
            
            // Send SOS emergency signal to server
            socket.emit('sos_emergency', {
                timestamp: new Date().toISOString(),
                driver_id: 1, // Current driver ID
                location: 'Current Location', // In real app, get from GPS
                emergency_type: 'manual_sos',
                priority: 'critical'
            });
            
            // Log in history
            addHistoryItem('EMERGENCY SOS ACTIVATED - MANUAL TRIGGER', 'sos');
            
            // Auto-reset after 10 seconds
            setTimeout(() => {
                sosButton.classList.remove('pulsing');
                sosAlert.style.display = 'none';
                console.log('üîÑ SOS alert auto-reset');
            }, 10000);
        }

        function updateDriversList(driversData) {
            driversList.innerHTML = '';
            let activeCount = 0;
            
            const driversToShow = driversData || drivers;
            
            driversToShow.forEach(driver => {
                if (driver.status !== 'offline') activeCount++;
                
                const driverItem = document.createElement('div');
                driverItem.className = `driver-item ${driver.status === 'danger' ? 'alert' : driver.status === 'warning' ? 'warning' : ''}`;
                
                // Create initials for avatar
                const initials = driver.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                driverItem.innerHTML = `
                    <div class="driver-info">
                        <div class="driver-avatar">${initials}</div>
                        <div class="driver-details">
                            <div class="driver-name">${driver.name}</div>
                            <div class="driver-vehicle">${driver.vehicle} ‚Ä¢ ${driver.location}</div>
                        </div>
                    </div>
                    <div class="driver-status">
                        <span class="status-badge ${getStatusClass(driver.status)}">${getStatusText(driver.status)}</span>
                        <div class="driver-actions">
                            <button class="action-btn contact" onclick="contactDriver('${driver.name}', '${driver.phone}')">Call</button>
                            <button class="action-btn view" onclick="viewDriverDetails(${driver.id})">View</button>
                            <button class="action-btn delete" onclick="deleteDriver(${driver.id})">Delete</button>
                        </div>
                    </div>
                `;
                
                driversList.appendChild(driverItem);
            });
            
            activeDriversCount.textContent = activeCount;
        }

        function getStatusClass(status) {
            return status === 'safe' ? 'status-safe' : status === 'warning' ? 'status-warning' : 'status-danger';
        }

        function getStatusText(status) {
            return status === 'safe' ? 'Safe' : status === 'warning' ? 'Warning' : 'Danger';
        }

        function contactDriver(name, phone) {
            alert(`Calling ${name} at ${phone}`);
        }

        function viewDriverDetails(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (driver) {
                alert(`Driver Details:\nName: ${driver.name}\nVehicle: ${driver.vehicle}\nPhone: ${driver.phone}\nLocation: ${driver.location}\nStatus: ${driver.status}`);
            }
        }

        function addHistoryItem(message, status) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const statusClass = status === 'closed' ? 'status-closed-badge' : status === 'sos' ? 'status-sos-badge' : 'status-open-badge';
            
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <span class="history-time">${timeString}</span>
                <span class="history-status ${statusClass}">${message}</span>
            `;
            
            historyList.prepend(item);
            if (historyList.children.length > 10) historyList.removeChild(historyList.lastChild);
        }

        function updateAlertLevel(duration) {
            let level = 'Low', color = '#4ade80';
            let previousLevel = alertLevel.textContent;
            
            if (duration >= alertThreshold && duration < alertThreshold + 5) { 
                level = 'Medium'; color = '#f59e0b'; 
            }
            if (duration >= alertThreshold + 5 && duration < alertThreshold + 10) { 
                level = 'High'; color = '#ef4444'; 
            }
            if (duration >= alertThreshold + 10) { 
                level = 'Critical'; color = '#dc2626'; 
                
                // Play critical alert sound when level becomes Critical
                if (previousLevel !== 'Critical') {
                    console.log("üö® CRITICAL ALERT LEVEL REACHED - PLAYING ALARM");
                    playCriticalAlertSound();
                    
                    // Play sound repeatedly every 5 seconds during critical alert
                    criticalAlertInterval = setInterval(() => {
                        if (alertLevel.textContent === 'Critical') {
                            playCriticalAlertSound();
                        } else {
                            clearInterval(criticalAlertInterval);
                        }
                    }, 5000);
                }
            } else {
                // Clear interval if level is no longer critical
                if (criticalAlertInterval) {
                    clearInterval(criticalAlertInterval);
                    criticalAlertInterval = null;
                }
            }
            
            alertLevel.textContent = level;
            alertLevel.style.color = color;
        }

        // Initialize with sample drivers
        updateDriversList(drivers);

        // Initialize alert settings
        updateAlertInfo();

        console.log("üéØ Alerion Client initialized - Driver Safety Monitor Ready");
    </script>
</body>
</html>